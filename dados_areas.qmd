---
title: "Dados de √Åreas"
bibliography: referencia.bib
---

<a id="dados-de-areas"></a>

Dados de √°reas (areal data) s√£o observa√ß√µes agregadas em unidades espaciais discretas, como bairros, munic√≠pios ou regi√µes administrativas. Essas unidades s√£o representadas por pol√≠gonos em um sistema de informa√ß√£o geogr√°fica (SIG). Exemplos comuns incluem taxas de criminalidade por bairro, incid√™ncia de doen√ßas por munic√≠pio e dados socioecon√¥micos por regi√£o.

As √°reas podem ser regulares ou irregulares. Em geral, √°reas representadas por regi√µes geogr√°ficas como estados e munic√≠pios s√£o denominadas de espacialmente irregulares, enquanto √°reas representadas por pixels, como imagens de sensoriamento remoto, s√£o denominadas de espacialmente regulares (formado por uma grade de espa√ßos iguais) [@scalon2024].

Nesta abordagem, modelamos uma vari√°vel resposta agregada em pol√≠gonos (ex: taxas de crime por bairro) usando vari√°veis independentes, corrigindo a autocorrela√ß√£o espacial via matriz de pesos $W$.

Os dados das vari√°veis aleat√≥rias podem ser de qualquer tipo (cont√≠nuas, discretas, etc) e tipicamente, representam toda a √°rea, ou seja, n√£o se disp√µe da localiza√ß√£o exata dos eventos dentro da √°rea, mas sim de um valor que foi agregado para aquela √°rea. Embora esses dados estejam associados com toda a √°rea, em geral, eles s√£o atribu√≠dos a um ponto espec√≠fico dentro da √°rea, esse ponto pode ser o centroide da √°rea [@scalon2024].

O objetivo da an√°lise de dados de √°reas, √© o mesmo da an√°lise dos outros tipos de dados espaciais, ou seja, caracterizar o processo estoc√°stico que gerou os dados [@scalon2024].

Na an√°lise de dados de √°reas, como existe apenas um valor $z_i$ para a √°rea $W_i$, deve-se assumir algum tipo de estacionariedade e para alguns casos ser√° necess√°rio assumir a normalidade multivariada [@scalon2024]. 

Para esse tipo de an√°lise de dados espaciais, dados de √°reas, pode estar interessado em um ou mais objetivos.
Por exemplo, @scalon2024 cita alguns dos objetivos, que podem ser:  
-   Explorar o comportamento das vari√°veis aleat√≥rias na regi√£o de estudo;
-   Obter mapas mais suaves do que o mapa dos dados observados;
-   etc...

Para a realiza√ß√£o de estat√≠stica espacial, √© necess√°rio que os dados em an√°lise possuam o termo de autocorrela√ß√£o espacial entre a vari√°vel aleat√≥ria.

- Software

O software para este minicurso, ser√° o R, usando a IDE Rstudio.

- Estrutura dos arquivos de dados de √°reas

Formato vetorial poligonal, como shapefiles (.shp) ou arquivos GeoPackage (.gpkg), que armazenam as geometrias dos pol√≠gonos e seus atributos associados.

### Pacotes Utilizados

Para realizar a an√°lise de dados de √°reas, utilizaremos os seguintes pacotes:

::: {.callout-note title="üì¶ Pacotes R Necess√°rios" style="background-color: #e3f2fd;"}
Execute o c√≥digo abaixo para instalar as bibliotecas:

```{r}
#| eval: false
#| code-fold: true
install.packages(c(
  "sf", "spdata", "RColorBrewer", "spdep", "spatialreg", 
  "readxl", "dplyr", "ggplot2", "geobr", "ggspatial", "ggthemes", 
  "ggrepel", "viridis", "tmap", "car", "janitor"
))


```

-   **`sf`**: Para manipula√ß√£o de dados espaciais (Simple Features).
-   **`spdata`**: Cont√©m conjuntos de dados espaciais para exemplos.
-   **`RColorBrewer`**: Para cria√ß√£o de paletas de cores em mapas.
-   **`spdep`**: Para criar matrizes de pesos e testes de autocorrela√ß√£o.
-   **`spatialreg`**: Para ajustar modelos espaciais autoregressivos.
-   **`readxl`**: Para leitura de arquivos Excel (.xls, .xlsx).
-   **`dplyr`**: Para manipula√ß√£o de dados.
-   **`ggplot2`**: Para cria√ß√£o de gr√°ficos e visualiza√ß√£o de dados.
-   **`geobr`**: Para baixar shapefiles oficiais do Brasil (IBGE).
-   **`ggspatial`**: Adiciona elementos espaciais (norte, escala) ao `ggplot2`.
-   **`ggthemes`**: Temas adicionais para gr√°ficos.
-   **`ggrepel`**: Para r√≥tulos de texto que n√£o se sobrep√µem.
-   **`viridis`**: Paletas de cores acess√≠veis para visualiza√ß√£o de dados.
-   **`tmap`**: Para cria√ß√£o de mapas tem√°ticos flex√≠veis.
-   **`car`**: Para diagn√≥sticos de regress√£o (ex: VIF, QQ-plots).
-   **`janitor`**: Para limpeza de dados (ex: nomes de colunas).

**Obtendo ajuda:** Para consultar a documenta√ß√£o de um pacote ou fun√ß√£o, utilize os comandos `help()` ou `?`.

```{r}
#| eval: false
help(sf)
?sf
```

:::


## Modelo espacial autoregressivo - SAR

-   O modelo espacial autoregressivo (SAR) √© descrito conforme @Anselin1988

    \begin{equation}
        Y = \delta WY + X\beta + \epsilon
        \label{eq:sar}
    \end{equation}

-   Onde

-   $Y$ √© um vetor de observa√ß√µes ( n $\times$ 1 ) nas n √°reas

-   $X$ √© a matriz das vari√°veis independentes, de tamanho ( n $\times$ i ),

-   $\delta$ √© o coeficiente de defasagem da vari√°vel dependente espacial,

-   $\beta$ √© o vetor de par√¢metros da regress√£o, de tamanho ( i $\times$ 1 ),

-   $W$ √© a matriz de pondera√ß√£o, de tamanho ( n $\times$ n ),

-   $\epsilon$ √© o vetor de erros, de tamanho ( n $\times$ 1 ) n√£o correlacionados que seguem uma distribui√ß√£o normal com m√©dia zero e vari√¢ncia constante, isto √©, $\epsilon \sim N(0, I\sigma^2$)

## Exemplo Pr√°tico: An√°lise de Chikungunya

Abaixo apresentamos o passo a passo da an√°lise, utilizando dados reais de incid√™ncia.

### 1. Carregamento de Pacotes

Primeiramente, carregamos todas as bibliotecas que ser√£o utilizadas na an√°lise.

```{r}
#| message: false
#| warning: false
#| eval: false
library(readxl)
library(dplyr)
library(stringr)
library(geobr)
library(sf)
library(spdep)
library(spatialreg)
library(ggplot2)
library(ggspatial)
library(ggthemes)
library(ggrepel)
library(viridis)
library(tmap)
library(car)
library(janitor)
```

### Carregamento e Tratamento dos Dados

```{r}
#| eval: false
# Carregando dados de incid√™ncia
dados <- read_excel("C:/Meus_documentos/Congresso_MGEST_2025/Chikugunha/dados/chiku.xlsx")
dados <- janitor::clean_names(dados)
dados <- dados |> 
  select(cod, muni, x2023_0) |> 
  mutate(x2023_0 = as.numeric(replace(x2023_0, x2023_0 == "-", 0))) 

# Carregando dados de densidade/popula√ß√£o
dados1 <- read_excel("C:/Meus_documentos/Congresso_MGEST_2025/Chikugunha/dados/densidad.xlsx", sheet = 3)
dados1 <- dados1 |>
  separate(muni, into = c("Municipio", "Estado"), sep = " \\(") %>%
  mutate(Estado = gsub("\\)", "", Estado))
dados1 <- dados1[-c(1, 219:222),-2 ] # Limpeza de linhas
```

### Obten√ß√£o da Malha e Unifica√ß√£o

```{r}
#| eval: false
# Baixar malha municipal (MA)
todos <- read_municipality(code_muni = "all", year = 2022, showProgress = FALSE)
ma <- filter(todos, abbrev_state == "MA")
ma <- ma |> 
  mutate(code_muni = str_sub(code_muni, 1, -2), 
         code_muni = as.numeric(code_muni))

# Unifica√ß√£o (Join)
dados_juntos <- ma |> 
  left_join(dados, by = c("code_muni" = "cod"))
dados_juntos <- dados_juntos[, -c(4,5,7,8)]

dad <- cbind(dados_juntos, dados1) |> 
  mutate(across(everything(), ~replace_na(., 0))) |>
  mutate(popu = as.numeric(popu))
dad <- dad[, -c(3,4,6)]

# C√°lculo da taxa de incid√™ncia
dad <- dad |> 
  mutate(inc_100 =  (x2023_0 / popu)*10000, .after =x2023_0,
         log_inc_100 =  log((x2023_0 / popu)*10000))
```

### An√°lise Explorat√≥ria e OLS

```{r}
#| eval: false
# Gr√°ficos explorat√≥rios
par(mfrow = c(1,2))
boxplot(dad$inc_100, main = "Incid√™ncia")
hist(dad$inc_100, main = "Histograma")

# Regress√£o Linear (OLS)
modelo_lm_2 <- lm(inc_100 ~ area_da_unidade + densidade_demogr√°fica, data = dad)
summary(modelo_lm_2)

# Diagn√≥stico
vif(modelo_lm_2)
qqPlot(modelo_lm_2$residuals, main = "QQ Plot OLS")
```

### Autocorrela√ß√£o Espacial

```{r}
#| eval: false
# Matriz de vizinhan√ßa e pesos
nb <- poly2nb(dad$geom, queen=TRUE)
lw <- nb2listw(nb, style="W", zero.policy=TRUE)

# Teste de Moran Global
moran.test(dad$inc_100, lw, randomisation = TRUE)

# Diagrama de Dispers√£o de Moran
moran.plot(modelo_lm_2$residual, lw, main = "Diagrama de Dispers√£o de Moran (OLS)")
```

### Modelagem Espacial (SAR e SEM)

```{r}
#| eval: false
# Modelo SAR (Spatial Lag)
modelo_sar1 <- lagsarlm(inc_100 ~ area_da_unidade + densidade_demogr√°fica, 
                        data = dad, listw = lw, zero.policy = TRUE)
summary(modelo_sar1)

# Modelo SEM (Spatial Error) - Referido como CAR no c√≥digo original
modelo_car1 <- errorsarlm(inc_100 ~ area_da_unidade + densidade_demogr√°fica, 
                          data = dad, listw = lw, zero.policy = TRUE)
summary(modelo_car1)
```

### Visualiza√ß√£o e Mapas

```{r}
#| eval: false
# Adicionando resultados ao mapa
dad$pred_sar <- modelo_sar1$fitted.values
dad$resid_sar <- residuals(modelo_sar1)

# Mapa de Predi√ß√£o
ggplot(dad) +
  geom_sf(aes(fill = pred_sar), color = NA) +
  scale_fill_viridis_c(option = "magma", name = "Predi√ß√£o SAR") +
  annotation_scale(location = "bl", width_hint = 0.4) +
  annotation_north_arrow(location = "tl", which_north = "true") +
  theme_minimal()

# Clusters LISA
dad_sf <- st_as_sf(dad)
lisa <- localmoran(dad_sf$inc_100, lw)
dad_sf$lisa_i <- lisa[,1]
dad_sf$pval <- lisa[,5]

dad_sf <- dad_sf %>%
  mutate(cluster = case_when(
    lisa_i > 0 & pval <= 0.05 & inc_100 > mean(inc_100) ~ "Alto-Alto",
    lisa_i > 0 & pval <= 0.05 & inc_100 < mean(inc_100) ~ "Baixo-Baixo",
    lisa_i < 0 & pval <= 0.05 & inc_100 > mean(inc_100) ~ "Alto-Baixo",
    lisa_i < 0 & pval <= 0.05 & inc_100 < mean(inc_100) ~ "Baixo-Alto",
    TRUE ~ "N√£o significativo"
  ))

tm_shape(dad_sf) +
  tm_polygons("cluster", palette = c("red", "blue", "white", "lightblue", "gray80"))
```